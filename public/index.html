<!DOCTYPE html>
<html>
    <head>
        <title>NUbugger</title>
        <link rel="stylesheet" type="text/css" href="/stylesheets/style.css">
        <link rel="stylesheet" type="text/css" href="/javascripts/ext-4.1.1a/resources/css/ext-all.css">
        <script type="text/javascript" src="/javascripts/ext-4.1.1a/ext-all-dev.js"></script>
        <script type="text/javascript" src="/javascripts/jquery-1.8.3.min.js"></script>
        <script type="text/javascript" src="/javascripts/raphael-min.js"></script>
        <script type="text/javascript" src="/javascripts/g.line-min.js"></script>
        <script type="text/javascript" src="/javascripts/three.js"></script>
        <script type="text/javascript" src="/javascripts/Data.js"></script>
        <script type="text/javascript" src="/javascripts/components/DarwinOP.js"></script>
        <script type="text/javascript" src="/javascripts/components/Field.js"></script>
        <script type="text/javascript" src="/javascripts/components/Ball.js"></script>
        <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    </head>
    <body>
        <script type="text/javascript">
            
            var orientation = new THREE.Vector3();
            
            Ext.application({
                name: 'NUbugger',    
                autoCreateViewport: true,
                launch: function() {
                    
                    console.log('serp');
                    
                    init();
                    animate();
                    
                }
            });
            
            var socket = io.connect('http://localhost:9090');
            
            socket.on('state', function (data) {
                
                //Ext.get('test').update(JSON.stringify(data));
                
                // orientation
                Data.robot.sensors.orientation.set(data.sensors.orientation);
                
                // update motors
                
                var motors = Data.robot.motors;
                var motor_data = data.motors;
                
                // head
                motors.head.angle.set(motor_data.HeadPitch.position);
                motors.neck.angle.set(motor_data.HeadYaw.position);
                
                // right arm
                // offset by pi/2 since 0 is arms straight out but model has 0 as arms straight down
                motors.rightShoulder.angle.set(motor_data.RShoulderPitch.position - Math.PI/2);
                motors.rightUpperArm.angle.set(motor_data.RShoulderRoll.position);
                motors.rightLowerArm.angle.set(motor_data.RElbowPitch.position);
                
                // left arm
                // offset by pi/2 since 0 is arms straight out but model has 0 as arms straight down
                motors.leftShoulder.angle.set(motor_data.LShoulderPitch.position - Math.PI/2);
                motors.leftUpperArm.angle.set(motor_data.LShoulderRoll.position);
                motors.leftLowerArm.angle.set(motor_data.LElbowPitch.position);
                
                // right pelvis
                motors.rightPelvis.angle.set(motor_data.RHipRoll.position);
                motors.rightPelvisY.angle.set(motor_data.RHipYaw.position);
                
                // left pelvis
                motors.leftPelvis.angle.set(motor_data.LHipRoll.position);
                motors.leftPelvisY.angle.set(motor_data.LHipYaw.position);
                
                // right leg
                motors.rightUpperLeg.angle.set(motor_data.RHipPitch.position);
                motors.rightLowerLeg.angle.set(motor_data.RKneePitch.position);
                motors.rightAnkle.angle.set(motor_data.RAnklePitch.position);
                motors.rightFoot.angle.set(motor_data.RAnkleRoll.position);
                
                // left leg
                motors.leftUpperLeg.angle.set(motor_data.LHipPitch.position);
                motors.leftLowerLeg.angle.set(motor_data.LKneePitch.position);
                motors.leftAnkle.angle.set(motor_data.LAnklePitch.position);
                motors.leftFoot.angle.set(motor_data.LAnkleRoll.position);
                
                // localisation
                
                // update robots position
                Data.robot.localization.position.set([data.self_x/100, data.self_y/100]);
                
            });
            
            var darwin, field, ball;
            var camera, scene, renderer;
            var geometry, material, mesh;
            var ypos = 0;
            
            function init () {
                
                scene = new THREE.Scene();
                
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.00001, 100);
                
                camera.position.x = -0.5;
                camera.position.z = 5.0;
                camera.position.y = 2.5;
                
                camera.position.x = -0.2;
                camera.position.z = 0.7;
                camera.position.y = 0.5;
                
                camera.lookAt(scene.position);
                
                darwin = new DarwinOP();
                darwin.bindToData(Data);
                
                field = new Field();
                ball = new Ball();
                
                scene.add(darwin.getRootElement());
                scene.add(field.field);
                //scene.add(ball.ball);
                
                light = new THREE.DirectionalLight(0x666666, 3.5, 500);
                light.position = camera.position;
                light.lookAt(scene.position);
                scene.add(this.light);
                
                renderer = new THREE.WebGLRenderer({antialias: true});
                renderer.setClearColorHex(0x0);
                renderer.setSize(window.innerWidth, window.innerHeight);
                
                //document.body.appendChild(renderer.domElement);
                
                Ext.getCmp('main_3d_display').body.appendChild(renderer.domElement);
                
                //window.addEventListener('resize', onWindowResize, false);
                
            }

            function resizeScene (width, height) {
                
                if (camera === undefined) {
                    // not initialized
                    return;
                }
                
                console.log(width, height);
                camera.aspect = width / width;
                camera.updateProjectionMatrix();
                
                renderer.setSize( width, height);
            }
            
            function animate () {
                
                // note: three.js includes requestAnimationFrame shim
                requestAnimationFrame( animate );
                
                renderer.render( scene, camera );
                
            }
        </script>
    </body>
</html>